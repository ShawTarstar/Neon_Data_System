<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.taxing.tliaswebmanagement.mapper.oracle.OracleStudentMapper">

    <!-- ====================== insert ====================== -->
    <insert id="insert">
        INSERT INTO "student"
        (
            "id","name","no","gender","phone","id_card","is_college","address",
            "degree","graduation_date","clazz_id","violation_count",
            "violation_score","create_time","update_time"
        )
        VALUES
            (
                #{id},#{name}, #{no}, #{gender}, #{phone}, #{idCard}, #{isCollege},
                #{address}, #{degree}, #{graduationDate}, #{clazzId},
                #{violationCount}, #{violationScore}, #{createTime}, #{updateTime}
            )
    </insert>

    <!-- ====================== update ====================== -->
    <update id="update">
        UPDATE "student"
        <set>
            <if test="name!=null and name!=''">
                "name" = #{name},
            </if>
            <if test="no!=null and no!=''">
                "no" = #{no},
            </if>
            <if test="gender!=null">
                "gender" = #{gender},
            </if>
            <if test="phone!=null and phone!=''">
                "phone" = #{phone},
            </if>
            <if test="degree!=null">
                "degree" = #{degree},
            </if>
            <if test="clazzId!=null">
                "clazz_id" = #{clazzId},
            </if>
            <if test="idCard!=null and idCard!=''">
                "id_card" = #{idCard},
            </if>
            <if test="isCollege!=null">
                "is_college" = #{isCollege},
            </if>
            <if test="address!=null and address!=''">
                "address" = #{address},
            </if>
            <if test="graduationDate!=null">
                "graduation_date" = #{graduationDate},
            </if>
            <if test="violationCount!=null">
                "violation_count" = #{violationCount},
            </if>
            <if test="violationScore!=null">
                "violation_score" = #{violationScore},
            </if>
            <if test="updateTime!=null">
                "update_time" = #{updateTime}
            </if>
        </set>
        WHERE "id" = #{id}
    </update>

    <!-- ====================== violation ====================== -->
    <update id="violation">
        UPDATE "student"
        SET
            "violation_count" = "violation_count" + 1,
            "violation_score" = "violation_score" + #{score},
            "update_time" = #{updateTime}
        WHERE "id" = #{id}
    </update>

    <!-- ====================== 更新 student_login ====================== -->
    <update id="updateStudentLoginInfo">
        UPDATE "student_login"
        <set>
            <if test="name!=null and name!=''">
                "name" = #{name},
            </if>
            <if test="no!=null and no!=''">
                "no" = #{no},
            </if>
        </set>
        WHERE "id" = #{id}
    </update>

    <!-- ====================== delete ====================== -->
    <delete id="delete">
        DELETE FROM "student"
        WHERE "id" IN
        <foreach collection="ids" item="id" open="(" close=")" separator=",">
            #{id}
        </foreach>
    </delete>

    <!-- ====================== 分页查询 ====================== -->
    <select id="page" resultType="com.taxing.tliaswebmanagement.pojo.Student">
        SELECT
        s."id",
        s."name",
        s."no",
        s."gender",
        s."phone",
        s."degree",
        s."id_card",
        s."is_college",
        s."address",
        s."graduation_date",
        s."violation_count",
        s."violation_score",
        s."clazz_id",
        c."name" AS "clazz_name",
        s."create_time",
        s."update_time"
        FROM "student" s
        LEFT JOIN "clazz" c ON s."clazz_id" = c."id"
        <where>
            <if test="name!=null and name!=''">
                s."name" LIKE '%' || #{name} || '%'
            </if>
            <if test="degree!=null">
                AND s."degree" = #{degree}
            </if>
            <if test="clazzId!=null">
                AND s."clazz_id" = #{clazzId}
            </if>
        </where>
    </select>

    <!-- ====================== selectById ====================== -->
    <select id="selectById" resultType="com.taxing.tliaswebmanagement.pojo.Student">
        SELECT
            "id","name","no","phone","gender","degree","id_card",
            "is_college","address","graduation_date",
            "violation_count","violation_score",
            "clazz_id","create_time","update_time"
        FROM "student"
        WHERE "id" = #{id}
    </select>

    <!-- ====================== 统计各班学生数 ====================== -->
    <select id="getStudentCountData" resultType="java.util.Map">
        SELECT
            c."name",
            COUNT(*) AS "num"
        FROM "clazz" c
                 LEFT JOIN "student" s ON c."id" = s."clazz_id"
        GROUP BY c."name"
    </select>

    <!-- ====================== 学历统计 ====================== -->
    <select id="getStudentDegreeData" resultType="java.util.Map">
        SELECT
            CASE
                WHEN "degree" = 1 THEN '初中'
                WHEN "degree" = 2 THEN '高中'
                WHEN "degree" = 3 THEN '大专'
                WHEN "degree" = 4 THEN '本科'
                WHEN "degree" = 5 THEN '硕士'
                WHEN "degree" = 6 THEN '博士'
                ELSE '其他'
                END AS "name",
            COUNT(*) AS "value"
        FROM "student"
        GROUP BY "degree"
    </select>

</mapper>
